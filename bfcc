#!/usr/bin/perl

use warnings;
use strict;
use 5.010;
use File::Basename;
use File::Slurp qw<read_file write_file>;

my %subs = (
    ',' => '*h=getchar();',   # Read a character from stdin, 255 on EOF
    '.' => 'putchar(*h);',    # Write a character to stdout
    '-' => '--*h;',           # Decrement tape
    '+' => '++*h;',           # Increment tape
    '<' => '--h;',            # Move head left
    '>' => '++h;',            # Move head right
    '[' => 'while(*h) {',     # Start loop
    ']' => '}',               # End loop
);
$_ .= "\n" for values %subs;

my $header = <<END_HEADER;
#include <stdlib.h>

int main() {
    unsigned char* h;
    h = calloc(10000, 1);
END_HEADER

my $footer = <<END_FOOTER;
    return 0;
}
END_FOOTER

foreach my $bf_file (@ARGV) {
    my $code = read_file($bf_file);
    {
        no warnings qw<uninitialized>;
        $code =~ s/(.)/$subs{$1}/xmsg;
    }

    my $cfile = basename($bf_file, ".bf").".c";
    write_file($cfile, $header, $code, $footer);

    system("gcc", $cfile) == 0 or exit 1;
}
